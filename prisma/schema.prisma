// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// V1 MVP Schema - Community OS
// ============================================================================
// Aligned with phases.json (6 phases, 12-16 weeks)
// Soft delete pattern: All entities have deletedAt field
// Version history: ContentVersion tracks post/comment revisions
// ============================================================================

// ----------------------------------------------------------------------------
// Phase 1: Foundation - Auth, User Roles, Dark Mode
// ----------------------------------------------------------------------------

model User {
  id        String    @id @default(cuid())
  clerkId   String    @unique // Clerk.com user ID
  email     String    @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relationships
  memberships       CommunityMember[]
  posts             Post[]
  comments          Comment[]
  instructedCourses Course[]          @relation("InstructedCourses")
  courseProgresses  CourseProgress[]
  certificates      Certificate[]
  notifications     Notification[]
  subscriptions     Subscription[]

  @@index([clerkId])
  @@index([email])
  @@map("users")
}

model Community {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  logoUrl     String?
  darkMode    Boolean   @default(false) // Community default (users can override)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete

  // Relationships
  members       CommunityMember[]
  posts         Post[]
  courses       Course[]
  paymentTiers  PaymentTier[]
  subscriptions Subscription[]
  coupons       Coupon[]
  notifications Notification[]
  spaces        Space[]
  channels      Channel[]

  @@index([slug])
  @@map("communities")
}

enum Role {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
  GUEST
}

model CommunityMember {
  id          String    @id @default(cuid())
  userId      String
  communityId String
  role        Role      @default(MEMBER)
  joinedAt    DateTime  @default(now())
  deletedAt   DateTime? // Soft delete

  // Relationships
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@index([role])
  @@map("community_members")
}

// ----------------------------------------------------------------------------
// Phase 2: Forums - Posts, Comments, Rich Text
// ----------------------------------------------------------------------------

model Post {
  id           String    @id @default(cuid())
  communityId  String
  authorId     String
  title        String
  content      String    @db.Text // Rich text HTML
  isPinned     Boolean   @default(false)
  isSolved     Boolean   @default(false)
  likeCount    Int       @default(0)
  helpfulCount Int       @default(0)
  commentCount Int       @default(0)
  viewCount    Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  publishedAt  DateTime? // Null = draft
  deletedAt    DateTime? // Soft delete (7-day retention)

  // Relationships
  community   Community        @relation(fields: [communityId], references: [id], onDelete: Cascade)
  author      User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments    Comment[]
  attachments PostAttachment[]
  versions    ContentVersion[]

  @@index([communityId])
  @@index([authorId])
  @@index([createdAt])
  @@index([publishedAt])
  @@index([deletedAt])
  @@map("posts")
}

model PostAttachment {
  id        String    @id @default(cuid())
  postId    String
  fileName  String
  fileUrl   String // S3 URL
  fileSize  Int // Bytes
  mimeType  String
  createdAt DateTime  @default(now())
  deletedAt DateTime? // Soft delete

  // Relationships
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("post_attachments")
}

model Comment {
  id           String    @id @default(cuid())
  postId       String
  authorId     String
  parentId     String? // For threading (max 2 levels in V1)
  content      String    @db.Text // Rich text HTML
  likeCount    Int       @default(0)
  helpfulCount Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime? // Soft delete (7-day retention)

  // Relationships
  post     Post             @relation(fields: [postId], references: [id], onDelete: Cascade)
  author   User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent   Comment?         @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[]        @relation("CommentReplies")
  versions ContentVersion[]

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("comments")
}

// ----------------------------------------------------------------------------
// Phase 3: Version History & Undelete
// ----------------------------------------------------------------------------

enum ContentType {
  POST
  COMMENT
}

model ContentVersion {
  id            String      @id @default(cuid())
  contentType   ContentType
  contentId     String // Post or Comment ID
  content       String      @db.Text // Snapshot of content at save
  versionNumber Int
  createdAt     DateTime    @default(now())

  // Relationships (polymorphic via contentId + contentType)
  post    Post?    @relation(fields: [contentId], references: [id], onDelete: Cascade, map: "content_versions_post_id_fkey")
  comment Comment? @relation(fields: [contentId], references: [id], onDelete: Cascade, map: "content_versions_comment_id_fkey")

  @@unique([contentId, versionNumber])
  @@index([contentId, contentType])
  @@index([createdAt])
  @@map("content_versions")
}

// ----------------------------------------------------------------------------
// Phase 4: Search, @Mentions, Notifications
// ----------------------------------------------------------------------------

enum NotificationType {
  MENTION
  REPLY
  LIKE
  COURSE_ENROLLMENT
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_CANCELLED
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  communityId String
  type        NotificationType
  message     String
  linkUrl     String? // Deep link to notification target
  actorId     String? // User who triggered the notification
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
  deletedAt   DateTime? // Soft delete

  // Relationships
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([communityId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ----------------------------------------------------------------------------
// Phase 5: Basic Courses
// ----------------------------------------------------------------------------

model Course {
  id           String    @id @default(cuid())
  communityId  String
  community    Community @relation(fields: [communityId], references: [id])
  title        String
  description  String    @db.Text
  instructorId String
  instructor   User      @relation("InstructedCourses", fields: [instructorId], references: [id])
  isPublished  Boolean   @default(false)
  publishedAt  DateTime?

  lessons      Lesson[]
  progresses   CourseProgress[]
  certificates Certificate[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([communityId])
  @@index([instructorId])
  @@index([isPublished])
  @@index([deletedAt])
  @@index([publishedAt])
  @@map("courses")
}

model Lesson {
  id              String    @id @default(cuid())
  courseId        String
  course          Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  sectionId       String? // V1: null, for future section support
  title           String
  content         String    @db.Text
  type            String // TEXT, VIDEO_EMBED, PDF
  videoUrl        String?
  pdfUrl          String?
  order           Int       @default(0)
  dripAvailableAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([courseId])
  @@index([order])
  @@index([dripAvailableAt])
  @@index([deletedAt])
  @@map("lessons")
}

model CourseProgress {
  id                   String    @id @default(cuid())
  courseId             String
  course               Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userId               String
  user                 User      @relation(fields: [userId], references: [id])
  completedLessonIds   String[] // Array of lesson IDs
  lastAccessedLessonId String?
  completedAt          DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, userId]) // One progress per user per course
  @@index([userId])
  @@index([courseId])
  @@index([completedAt])
  @@map("course_progresses")
}

model Certificate {
  id               String   @id @default(cuid())
  courseId         String
  course           Course   @relation(fields: [courseId], references: [id])
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  userName         String
  courseName       String
  instructorName   String
  issuedAt         DateTime @default(now())
  pdfUrl           String?
  verificationCode String   @unique

  createdAt DateTime @default(now())

  @@unique([courseId, userId]) // One certificate per user per course
  @@index([userId])
  @@index([verificationCode])
  @@map("certificates")
}

// ----------------------------------------------------------------------------
// Phase 6: Monetization - Stripe + Content Gating
// ----------------------------------------------------------------------------

model PaymentTier {
  id           String    @id @default(cuid())
  communityId  String
  name         String // e.g., "Free", "Premium", "Enterprise"
  description  String    @db.Text
  priceMonthly Int       @default(0) // Cents (0 = Free tier)
  priceAnnual  Int       @default(0) // Cents (0 = Free tier)
  features     String[] // Array of feature descriptions
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime? // Soft delete

  // Relationships
  community     Community      @relation(fields: [communityId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  channels      Channel[] // Tier-gated channels

  @@index([communityId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("payment_tiers")
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String
  communityId          String
  paymentTierId        String
  stripeSubscriptionId String?   @unique
  stripeCustomerId     String?
  status               String // ACTIVE, CANCELLED, PAST_DUE, TRIALING
  interval             String // MONTHLY, ANNUAL
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  trialEndsAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime? // Soft delete

  // Relationships
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  community   Community   @relation(fields: [communityId], references: [id], onDelete: Cascade)
  paymentTier PaymentTier @relation(fields: [paymentTierId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId]) // One subscription per user per community
  @@index([userId])
  @@index([communityId])
  @@index([stripeCustomerId])
  @@index([status])
  @@index([deletedAt])
  @@map("subscriptions")
}

model Coupon {
  id            String    @id @default(cuid())
  communityId   String
  code          String // Uppercase, e.g., "SAVE20"
  discountType  String // PERCENTAGE, FIXED_AMOUNT
  discountValue Int // Percentage (0-100) or cents
  expiresAt     DateTime?
  maxUses       Int? // Null = unlimited
  usedCount     Int       @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  // Relationships
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([communityId, code]) // Unique code per community
  @@index([communityId])
  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
  @@index([deletedAt])
  @@map("coupons")
}

// ----------------------------------------------------------------------------
// Phase 7: Multi-Space Layout & Organization (V2)
// ----------------------------------------------------------------------------

model Space {
  id            String    @id @default(cuid())
  communityId   String
  parentSpaceId String? // For nested spaces (max 2 levels)
  name          String // 1-100 characters
  description   String    @db.Text // Max 500 characters
  icon          String? // Icon identifier (emoji or icon name)
  color         String? // Hex color code for visual distinction
  position      Int       @default(0) // For ordering
  createdBy     String // User ID of creator
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  // Relationships
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  parentSpace Space?    @relation("SpaceHierarchy", fields: [parentSpaceId], references: [id], onDelete: Cascade)
  childSpaces Space[]   @relation("SpaceHierarchy")
  channels    Channel[]

  @@index([communityId])
  @@index([parentSpaceId])
  @@index([position])
  @@index([deletedAt])
  @@map("spaces")
}

model Channel {
  id             String    @id @default(cuid())
  communityId    String
  spaceId        String? // Null if standalone channel (not in a space)
  name           String // 1-100 characters
  description    String    @db.Text // Max 500 characters
  permission     String // PUBLIC, MEMBERS_ONLY, TIER_GATED
  requiredTierId String? // Required for TIER_GATED permission
  icon           String? // Icon identifier (emoji or icon name)
  position       Int       @default(0) // For ordering
  createdBy      String // User ID of creator
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime? // Soft delete

  // Relationships
  community     Community    @relation(fields: [communityId], references: [id], onDelete: Cascade)
  space         Space?       @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  requiredTier  PaymentTier? @relation(fields: [requiredTierId], references: [id], onDelete: SetNull)

  @@index([communityId])
  @@index([spaceId])
  @@index([permission])
  @@index([requiredTierId])
  @@index([position])
  @@index([deletedAt])
  @@map("channels")
}
